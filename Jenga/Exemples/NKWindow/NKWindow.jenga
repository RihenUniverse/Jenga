#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
=============================================================================
NKWindow.jenga â€” Workspace principal du framework NKWindow
=============================================================================

NKWindow est un framework C++ multi-plateforme de gestion de fenÃªtres,
d'Ã©vÃ©nements et de rendu pixel. Il fonctionne Ã  l'image de SDL3/SFML3
mais entiÃ¨rement en C++ moderne (C++17/C++20), sous le namespace nkentseu.

Architecture et ordre de dÃ©pendances :

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                                      â”‚
  â”‚  NKPlatform  â€” DÃ©tection OS/arch/compilateur/CPU         (C++20)    â”‚
  â”‚       â†“                                                              â”‚
  â”‚  NKCore      â€” Types, macros, assertions, bits            (C++20)    â”‚
  â”‚       â†“                                                              â”‚
  â”‚  NKLogger    â€” Journalisation asynchrone multi-sink       (C++17)    â”‚
  â”‚       â†“                                                              â”‚
  â”‚  NKWindow    â€” FenÃªtrage, Ã©vÃ©nements, camÃ©ra, rendu pxl   (C++17)    â”‚
  â”‚       â†“                                                              â”‚
  â”‚  Sandbox     â€” Application de dÃ©monstration (tous OS)     (C++17)    â”‚
  â”‚                                                                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Rendu : seul le rendu pixel (software) est implÃ©mentÃ© pour l'instant.
          Les autres backends (OpenGL, Vulkanâ€¦) seront dÃ©veloppÃ©s ensuite.

Plateformes supportÃ©es :
  Windows     â€” Backend Win32                   (clang-mingw)
  Linux XLib  â€” Backend X11/XLib (dÃ©faut)       (clang-native / WSL2)
  Linux XCB   â€” Backend X11/XCB                 (clang-native / WSL2)
  Linux Wayland â€” Backend Wayland + xdg-shell   (clang-native / WSL2)
  Linux NOOP  â€” Backend headless (CI/WSL)        (clang-native / WSL2)
  macOS       â€” Backend Cocoa                   (clang-native)
  Android     â€” NativeActivity+EGL              (android-ndk)
  iOS         â€” Backend UIKit
  Web         â€” Emscripten+Canvas               (emscripten)
  HarmonyOS   â€” ArkUI Native
  XboxSeries  â€” UWP GameCore                    (xbox-clang)
  XboxOne     â€” UWP GameCore                    (xbox-clang)

Namespace : nkentseu
Nomenclature : voir NOMENCLATURE_ET_DOCUMENTATION.md

Usage :
  jenga build                                            # HÃ´te (XLib)
  jenga build --platform windows                         # Windows
  jenga build --platform linux                           # Linux XLib (dÃ©faut)
  jenga build --platform linux --options linux-backend=xcb      # Linux XCB
  jenga build --platform linux --options linux-backend=wayland   # Linux Wayland
  jenga build --platform linux --options headless                # Linux headless
  jenga build --platform macos                           # macOS Cocoa
  jenga build --platform android                         # Android (NDK)
  jenga build --platform ios                             # iOS (UIKit)
  jenga build --platform web                             # Web (Emscripten)
  jenga build --platform harmonyos                       # HarmonyOS
  jenga build --platform xboxseries                      # Xbox Series X/S
  jenga build --platform xboxone                         # Xbox One
  jenga build --config Release                           # Build Release

  Notes Wayland :
    PrÃ©requis : libwayland-dev, libxkbcommon-dev, wayland-protocols
    GÃ©nÃ©rer xdg-shell-client-protocol.h :
      wayland-scanner client-header \\
        /usr/share/wayland-protocols/stable/xdg-shell/xdg-shell.xml \\
        NKWindow/src/NKWindow/Platform/Wayland/xdg-shell-client-protocol.h
      wayland-scanner private-code \\
        /usr/share/wayland-protocols/stable/xdg-shell/xdg-shell.xml \\
        NKWindow/src/NKWindow/Platform/Wayland/xdg-shell-protocol.c

Auteur : Rihen
Date   : 2026
=============================================================================
"""

import os
import shutil
from Jenga import *
from Jenga.GlobalToolchains import RegisterJengaGlobalToolchains

with workspace("NKWindow", location="."):
    RegisterJengaGlobalToolchains()

    # Platform-specific toolchain names to avoid ambiguity/collisions.
    TC_WINDOWS = "nk-windows-clang-mingw"

    # Register a local Windows toolchain with explicit host resolution.
    # This avoids machine-specific absolute paths from global toolchain files.
    if os.name == "nt":
        _clang = shutil.which("clang")
        _clangxx = shutil.which("clang++")
        _llvm_ar = shutil.which("llvm-ar") or shutil.which("ar")
        if not _clang and os.path.exists(r"C:\msys64\ucrt64\bin\clang.exe"):
            _clang = r"C:\msys64\ucrt64\bin\clang.exe"
        if not _clangxx and os.path.exists(r"C:\msys64\ucrt64\bin\clang++.exe"):
            _clangxx = r"C:\msys64\ucrt64\bin\clang++.exe"
        if not _llvm_ar and os.path.exists(r"C:\msys64\ucrt64\bin\llvm-ar.exe"):
            _llvm_ar = r"C:\msys64\ucrt64\bin\llvm-ar.exe"
        if not _llvm_ar and os.path.exists(r"C:\msys64\ucrt64\bin\ar.exe"):
            _llvm_ar = r"C:\msys64\ucrt64\bin\ar.exe"

        with toolchain(TC_WINDOWS, "clang"):
            settarget("Windows", "x86_64", "mingw")
            targettriple(r"x86_64-w64-windows-gnu")
            ccompiler(_clang or "clang")
            cppcompiler(_clangxx or "clang++")
            linker(_clangxx or "clang++")
            if _llvm_ar:
                archiver(_llvm_ar)
            cflags(["--target=x86_64-w64-windows-gnu"])
            cxxflags(["--target=x86_64-w64-windows-gnu"])
            ldflags(["--target=x86_64-w64-windows-gnu"])

    configurations(["Debug", "Release"])

    # â”€â”€ Options Linux : choix du backend de fenÃªtrage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Par dÃ©faut : xlib
    # Autres valeurs : xcb, wayland, headless
    newoption(
        trigger="linux-backend",
        value="BACKEND",
        allowed=[
            ["xlib",     "X11/XLib  (dÃ©faut, le plus compatible)"],
            ["xcb",      "X11/XCB   (plus lÃ©ger, asynchrone)"],
            ["wayland",  "Wayland   (compositeurs modernes, sans X11)"],
            ["headless", "Pas de fenÃªtre (CI, serveurs, WSL sans Ã©cran)"],
        ],
        default="xlib",
        description="Backend de fenÃªtrage Linux"
    )

    # Alias court pour la compatibilitÃ© avec l'ancienne syntaxe
    newoption(
        trigger="headless",
        description="[ObsolÃ¨te] Utiliser --options linux-backend=headless"
    )

    # â”€â”€ Toutes les plateformes cibles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    targetoses([
        TargetOS.WINDOWS,
        TargetOS.LINUX,
        TargetOS.MACOS,
        TargetOS.ANDROID,
        TargetOS.IOS,
        TargetOS.WEB,
        TargetOS.HARMONYOS,
        TargetOS.XBOX_SERIES,
        TargetOS.XBOX_ONE,
    ])

    # â”€â”€ Architectures cibles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    targetarchs([
        TargetArch.X86_64,   # Desktop (Windows, Linux, macOS, Xbox)
        TargetArch.ARM64,    # Mobile  (Android, iOS)
        TargetArch.WASM32,   # Web     (Emscripten)
    ])

    # Shell plein Ã©cran pour les builds Web
    emscriptenfullscreenshell(True)

    # Chemins Android SDK/NDK depuis l'environnement
    androidsdkpath(os.getenv("ANDROID_SDK_ROOT", ""))
    androidndkpath(os.getenv("ANDROID_NDK_ROOT", os.getenv("ANDROID_NDK_HOME", "")))

    # Tests unitaires (desktop seulement)
    with unitest() as u:
        u.Compile()

    # =========================================================================
    # NKPlatform â€” DÃ©tection OS, architecture, compilateur, CPU (C++20)
    # =========================================================================
    # NKPlatform est la fondation sans dÃ©pendances. Elle fournit des macros
    # et des informations compilÃ©es sur l'environnement d'exÃ©cution.
    #
    # Contenu (src/NKPlatform/) :
    #   NkPlatformDetect.h    â€” OS (Windows, Linux, macOS, Android, iOS, Webâ€¦)
    #   NkArchDetect.h        â€” Architecture (x86_64, ARM64, WASM32)
    #   NkCompilerDetect.h    â€” Compilateur (MSVC, GCC, Clang, MinGW, Zigâ€¦)
    #   NkCPUFeatures.h/cpp   â€” CapacitÃ©s CPU (SSE2, AVX2, NEON, WASM SIMD)
    #   NkEndianness.h        â€” Endianness (little / big)
    #   NkPlatformConfig.h/cpp â€” Configuration compilÃ©e de la plateforme
    # =========================================================================

    with project("NKPlatform"):
        staticlib()
        language("C++")
        cppdialect("C++20")
        location("NKPlatform")

        includedirs([
            "src",
            "src/NKPlatform",
            "pch",
            "../NKCore/src",
            "../NKCore/src/NKCore",
        ])
        pchheader("pch/pch.h")
        pchsource("pch/pch.cpp")

        files([
            "src/NKPlatform/**.cpp",
            "src/NKPlatform/**.h",
        ])

        objdir("%{wks.location}/Build/Obj/%{cfg.buildcfg}-%{cfg.system}/%{prj.name}")
        targetdir("%{wks.location}/Build/Lib/%{cfg.buildcfg}-%{cfg.system}")

        # â”€â”€ Toolchains â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Windows"):
            usetoolchain(TC_WINDOWS)
        with filter("system:macOS"):
            usetoolchain("clang-native")
        with filter("system:Android"):
            usetoolchain("android-ndk")
        with filter("system:Web"):
            usetoolchain("emscripten")
        with filter("system:XboxSeries || system:XboxOne"):
            usetoolchain("xbox-clang")

        # â”€â”€ Debug / Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("config:Debug"):
            defines(["_DEBUG", "DEBUG"])
            optimize("Off")
            symbols(True)
        with filter("config:Release"):
            defines(["NDEBUG"])
            optimize("Speed")
            symbols(False)

    # =========================================================================
    # NKCore â€” Types, macros, assertions, opÃ©rations bit (C++20)
    # =========================================================================
    # NKCore s'appuie sur NKPlatform pour les types fixes et les macros
    # fondamentaux rÃ©utilisÃ©s par toutes les couches supÃ©rieures.
    #
    # Contenu (src/NKCore/) :
    #   NkTypes.h           â€” Types fixes (NkU8, NkI32, NkVec2u, NkRectâ€¦)
    #   NkMacros.h          â€” Macros utilitaires (NK_UNUSED, NK_STRINGIFYâ€¦)
    #   NkBits.h/cpp        â€” OpÃ©rations bit (popcount, clz, byteswapâ€¦)
    #   NkLimits.h/cpp      â€” Limites de types scalaires
    #   NkAtomic.h          â€” Atomiques portables (spin-lock, flags)
    #   NkConfig.h          â€” Configuration globale du build
    #   NkInline.h          â€” Macros NK_INLINE / NK_FORCE_INLINE
    #   NkBuiltin.h         â€” DÃ©tection __builtin_* de GCC/Clang
    #   NkVersion.h         â€” Version du framework (NK_VERSION_MAJOR/MINORâ€¦)
    #   Assert/             â€” Assertions configurables + debug break
    # =========================================================================

    with project("NKCore"):
        staticlib()
        language("C++")
        cppdialect("C++20")
        location("NKCore")

        includedirs([
            "src",
            "pch",
            "../NKPlatform/src",          # pour NKPlatform/NkXxx.h
            "../NKPlatform/src/NKPlatform", # pour NkPlatformDetect.h, NkArchDetect.h, NkCompilerDetect.h
        ])
        pchheader("pch/pch.h")
        pchsource("pch/pch.cpp")

        # NKCore dÃ©pend de NKPlatform
        dependson(["NKPlatform"])

        files([
            "src/NKCore/**.cpp",
            "src/NKCore/**.h",
        ])

        objdir("%{wks.location}/Build/Obj/%{cfg.buildcfg}-%{cfg.system}/%{prj.name}")
        targetdir("%{wks.location}/Build/Lib/%{cfg.buildcfg}-%{cfg.system}")

        defines(["NKENTSEU_CORE_STATIC"])

        # â”€â”€ Toolchains â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Windows"):
            usetoolchain(TC_WINDOWS)
        with filter("system:macOS"):
            usetoolchain("clang-native")
        with filter("system:Android"):
            usetoolchain("android-ndk")
        with filter("system:Web"):
            usetoolchain("emscripten")
        with filter("system:XboxSeries || system:XboxOne"):
            usetoolchain("xbox-clang")

        # â”€â”€ Debug / Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("config:Debug"):
            defines(["_DEBUG", "DEBUG", "NKENTSEU_DEBUG"])
            optimize("Off")
            symbols(True)
        with filter("config:Release"):
            defines(["NDEBUG", "RELEASE", "NKENTSEU_RELEASE"])
            optimize("Speed")
            symbols(False)

    # =========================================================================
    # NKLogger â€” Journalisation asynchrone multi-sink (C++17)
    # =========================================================================
    # NKLogger fournit un systÃ¨me de journalisation thread-safe avec filtres,
    # formatage configurable et plusieurs destinations (console, fichier, etc.)
    #
    # Contenu (src/Logger/) :
    #   Logger.h/cpp          â€” Logger principal (point d'entrÃ©e)
    #   Log.h/cpp             â€” Macros NK_LOG_*, fonctions de log globales
    #   AsyncLogger.h/cpp     â€” Logger asynchrone (file d'attente thread-safe)
    #   LogLevel.h/cpp        â€” Niveaux (TRACE, DEBUG, INFO, WARN, ERRORâ€¦)
    #   LogMessage.h/cpp      â€” Message de log (timestamp, thread, niveauâ€¦)
    #   Formatter.h/cpp       â€” Formatage des messages (patterns)
    #   Pattern.h             â€” Syntaxe des patterns de format
    #   Registry.h/cpp        â€” Registre global des loggers nommÃ©s
    #   Sink.h                â€” Interface ISink (destinations)
    #   Sinks/
    #     ConsoleSink         â€” Sortie console (ANSI couleurs)
    #     FileSink            â€” Fichier texte simple
    #     RotatingFileSink    â€” Fichier avec rotation par taille
    #     DailyFileSink       â€” Fichier avec rotation quotidienne
    #     AsyncSink           â€” Sink asynchrone (wraps un sink sync)
    #     DistributingSink    â€” Dispatche vers plusieurs sinks
    #     NullSink            â€” Sink /dev/null (tests, benchmarks)
    #   Filters/
    #     LevelFilter         â€” Filtre par niveau minimum
    #     PatternFilter       â€” Filtre par pattern (regex)
    #     ThreadFilter        â€” Filtre par thread ID
    # =========================================================================

    with project("NKLogger"):
        staticlib()
        language("C++")
        cppdialect("C++17")
        location("NKLogger")

        includedirs([
            "src",
            "pch",
            "../NKCore/src",
            "../NKCore/pch",
            "../NKPlatform/src",
            "../NKPlatform/src/NKPlatform",
        ])
        pchheader("pch/pch.h")
        pchsource("pch/pch.cpp")

        dependson(["NKCore", "NKPlatform"])

        files([
            "src/Logger/**.cpp",
            "src/Logger/**.h",
        ])

        objdir("%{wks.location}/Build/Obj/%{cfg.buildcfg}-%{cfg.system}/%{prj.name}")
        targetdir("%{wks.location}/Build/Lib/%{cfg.buildcfg}-%{cfg.system}")

        # Liaison des bibliothÃ¨ques systÃ¨me pour le threading
        with filter("system:Windows"):
            usetoolchain(TC_WINDOWS)
        with filter("system:Linux"):
            links(["pthread"])
        with filter("system:macOS"):
            usetoolchain("clang-native")
        with filter("system:Android"):
            usetoolchain("android-ndk")
            links(["log"])
        with filter("system:Web"):
            usetoolchain("emscripten")
        with filter("system:XboxSeries || system:XboxOne"):
            usetoolchain("xbox-clang")

        with filter("config:Debug"):
            defines(["_DEBUG", "DEBUG"])
            optimize("Off")
            symbols(True)
        with filter("config:Release"):
            defines(["NDEBUG"])
            optimize("Speed")
            symbols(False)

    # =========================================================================
    # NKWindow â€” FenÃªtrage, Ã©vÃ©nements, camÃ©ra 2D, rendu pixel (C++17)
    # =========================================================================
    # NKWindow est la bibliothÃ¨que principale du framework. Elle gÃ¨re tout ce
    # qui touche Ã  la fenÃªtre, aux entrÃ©es et au rendu pixel.
    #
    # Contenu (src/NKWindow/) :
    #
    #   Core/
    #     NkWindow.h/cpp          â€” FenÃªtre principale (faÃ§ade PIMPL â†’ IWindowImpl)
    #     NkEvent.h/cpp           â€” Ã‰vÃ©nement gÃ©nÃ©rique polymorphe
    #     NkEventSystem.h/cpp     â€” Dispatcher d'Ã©vÃ©nements (singleton)
    #     NkRenderer.h/cpp        â€” Renderer pixels (faÃ§ade PIMPL â†’ IRendererImpl)
    #     NkSystem.h/cpp          â€” Initialisation/destruction du framework
    #     NkGamepadSystem.h/cpp   â€” Gestion des manettes / joysticks
    #     NkCamera2D.h            â€” (deprecated temporairement)
    #     NkDialogs.h/cpp         â€” BoÃ®tes de dialogue fichiers cross-platform
    #     NkSurface.h             â€” Surface de rendu (taille, DPI, handle)
    #     NkSafeArea.h            â€” Safe area mobile (encoches, bords)
    #     NkEntry.h / NkMain.h    â€” Point d'entrÃ©e cross-platform (nkmain)
    #     NkTypes.h               â€” Types gÃ©omÃ©triques (NkVec2, NkRect, NkColorâ€¦)
    #     Events/                 â€” Types d'Ã©vÃ©nements typÃ©s (clavier, sourisâ€¦)
    #     Camera/                 â€” (deprecated temporairement)
    #
    #   Platform/
    #     Win32/      â€” Backend Windows (HWND, WndProc, DirectInput, XInput)
    #     XLib/       â€” Backend Linux X11 (Xlib, XInput2)
    #     XCB/        â€” Backend Linux XCB (alternatif Ã  XLib)
    #     Noop/       â€” Backend headless (tests, CI, WSL sans affichage)
    #     Cocoa/      â€” Backend macOS (.mm Objective-C++)
    #     UIKit/      â€” Backend iOS   (.mm Objective-C++)
    #     Android/    â€” Backend Android (NativeActivity + EGL)
    #     WASM/       â€” Backend Web (Emscripten + Canvas API)
    #     UWP/        â€” Backend Universal Windows Platform (Xbox)
    #
    #   Renderer/
    #     Software/   â€” Rendu pixel software (NkSoftwareRendererImpl)
    #                   SetPixel, DrawLine, FillRect, DrawCircle, FillTriangleâ€¦
    #                   C'est le seul systÃ¨me de rendu disponible pour l'instant.
    #                   Les Ã©tudiants ajouteront OpenGL, Vulkan, Metalâ€¦
    #
    #   EntryPoints/
    #     Macros et adaptateurs d'entrÃ©e pour chaque plateforme (main â†’ nkmain)
    # =========================================================================

    with project("NKWindow"):
        staticlib()
        language("C++")
        cppdialect("C++17")
        location("NKWindow")

        includedirs([
            "src",                          # NKWindow/src/
            "pch",                          # PCH NKWindow
            "../Externals",                 # stb, etc.
            "../NKCore/src",                # Types + macros fondamentaux
            "../NKCore/pch",                # pch NKCore
            "../NKPlatform/src",            # DÃ©tection plateforme/architecture
            "../NKPlatform/src/NKPlatform", # NkPlatformDetect.h, NkCompilerDetect.hâ€¦
            "../NKLogger/src",              # Journalisation
        ])
        pchheader("pch/pch.h")
        pchsource("pch/pch.cpp")

        dependson(["NKPlatform", "NKCore", "NKLogger"])

        # Fichiers communs (Core + Renderer â€” partagÃ©s par toutes les plateformes)
        files([
            "src/NKWindow/Core/**.cpp",
            "src/NKWindow/Core/**.h",
            "src/NKWindow/Renderer/**.cpp",
            "src/NKWindow/Renderer/**.h",
        ])

        objdir("%{wks.location}/Build/Obj/%{cfg.buildcfg}-%{cfg.system}/%{prj.name}")
        targetdir("%{wks.location}/Build/Lib/%{cfg.buildcfg}-%{cfg.system}")

        # â”€â”€ Windows (Win32 backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Windows"):
            usetoolchain(TC_WINDOWS)
            defines([
                "NKENTSEU_PLATFORM_WIN32=1",
                "NKENTSEU_FAMILY_WINDOWS=1",
                "WIN32_LEAN_AND_MEAN",
                "_UNICODE",
                "UNICODE",
            ])
            files([
                "src/NKWindow/Platform/Win32/**.cpp",
                "src/NKWindow/Platform/Win32/**.h",
            ])
            links([
                "user32", "gdi32", "opengl32", "dwmapi", "shell32",
                "xinput", "mf", "mfplat", "mfreadwrite", "mfuuid",
                "uuid", "ole32",
            ])

        # â”€â”€ Linux headless / NOOP (CI, serveurs, WSL sans Ã©cran) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Linux && options:linux-backend=headless || system:Linux && options:headless"):
            defines(["NKENTSEU_PLATFORM_NOOP=1", "NKENTSEU_FAMILY_LINUX=1"])
            objdir("%{wks.location}/Build/Obj/%{cfg.buildcfg}-%{cfg.system}-headless/%{prj.name}")
            targetdir("%{wks.location}/Build/Lib/%{cfg.buildcfg}-%{cfg.system}-headless")
            files([
                "src/NKWindow/Platform/Linux/**.h",
                "src/NKWindow/Platform/Noop/**.h",
            ])
            links(["pthread"])

        # â”€â”€ Linux XLib (X11/XLib â€” dÃ©faut) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Linux && options:linux-backend=xlib || system:Linux && !options:linux-backend && !options:headless"):
            defines(["NKENTSEU_PLATFORM_XLIB=1", "NKENTSEU_FAMILY_LINUX=1"])
            files([
                "src/NKWindow/Platform/Linux/**.h",
                "src/NKWindow/Platform/XLib/**.cpp",
                "src/NKWindow/Platform/XLib/**.h",
            ])
            links(["pthread", "X11"])

        # â”€â”€ Linux XCB (X11/XCB â€” asynchrone) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Linux && options:linux-backend=xcb"):
            defines(["NKENTSEU_PLATFORM_XCB=1", "NKENTSEU_FAMILY_LINUX=1"])
            files([
                "src/NKWindow/Platform/Linux/**.h",
                "src/NKWindow/Platform/XCB/**.cpp",
                "src/NKWindow/Platform/XCB/**.h",
            ])
            links(["pthread", "xcb", "xcb-icccm", "xcb-randr", "X11-xcb"])

        # â”€â”€ Linux Wayland (compositeurs modernes sans X11) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # PrÃ©requis : libwayland-dev, libxkbcommon-dev, wayland-protocols
        # GÃ©nÃ©rer xdg-shell-client-protocol.h avant de compiler :
        #   wayland-scanner client-header \
        #     /usr/share/wayland-protocols/stable/xdg-shell/xdg-shell.xml \
        #     NKWindow/src/NKWindow/Platform/Wayland/xdg-shell-client-protocol.h
        with filter("system:Linux && options:linux-backend=wayland"):
            defines(["NKENTSEU_PLATFORM_WAYLAND=1", "NKENTSEU_FAMILY_LINUX=1"])
            files([
                "src/NKWindow/Platform/Linux/**.h",
                "src/NKWindow/Platform/Wayland/**.cpp",
                "src/NKWindow/Platform/Wayland/**.h",
                "src/NKWindow/Platform/Wayland/xdg-shell-protocol.c",
            ])
            links(["pthread", "wayland-client", "xkbcommon"])

        # â”€â”€ macOS (Cocoa backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:macOS"):
            usetoolchain("clang-native")
            defines([
                "NKENTSEU_PLATFORM_COCOA=1",
                "NKENTSEU_FAMILY_APPLE=1",
            ])
            files([
                "src/NKWindow/Platform/Cocoa/**.cpp",
                "src/NKWindow/Platform/Cocoa/**.mm",
                "src/NKWindow/Platform/Cocoa/**.h",
            ])
            frameworks(["Cocoa", "QuartzCore", "OpenGL", "Metal"])

        # â”€â”€ Android (NativeActivity + EGL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Android"):
            usetoolchain("android-ndk")
            defines([
                "NKENTSEU_PLATFORM_ANDROID=1",
                "NKENTSEU_FAMILY_ANDROID=1",
            ])
            files([
                "src/NKWindow/Platform/Android/**.cpp",
                "src/NKWindow/Platform/Android/**.h",
            ])
            links(["android", "log", "EGL", "GLESv3"])
            androidapplicationid("com.nkentseu.nkwindow")
            androidminsdk(24)
            androidtargetsdk(34)
            androidcompilesdk(34)
            # Couvre physiques ARM + Ã©mulateurs x86
            androidabis(["armeabi-v7a", "arm64-v8a", "x86", "x86_64"])
            androidnativeactivity(True)

        # â”€â”€ iOS (UIKit backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:iOS"):
            defines([
                "NKENTSEU_PLATFORM_UIKIT=1",
                "NKENTSEU_FAMILY_APPLE=1",
            ])
            files([
                "src/NKWindow/Platform/UIKit/**.cpp",
                "src/NKWindow/Platform/UIKit/**.mm",
                "src/NKWindow/Platform/UIKit/**.h",
            ])
            frameworks(["UIKit", "QuartzCore", "OpenGLES", "AVFoundation"])
            iosbundleid("com.nkentseu.nkwindow")
            iosversion("1.0")
            iosminsdk("14.0")
            iosbuildnumber(1)

        # â”€â”€ Web (Emscripten + Canvas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Web"):
            usetoolchain("emscripten")
            defines([
                "NKENTSEU_PLATFORM_WASM=1",
                "__EMSCRIPTEN__=1",
            ])
            files([
                "src/NKWindow/Platform/WASM/**.cpp",
                "src/NKWindow/Platform/WASM/**.h",
            ])
            emscripteninitialmemory(32)  # 32 MB initial

        # â”€â”€ HarmonyOS (ArkUI Native â€” backend NOOP en attendant) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Le backend dÃ©diÃ© HarmonyOS est Ã  implÃ©menter.
        with filter("system:HarmonyOS"):
            defines([
                "NKENTSEU_PLATFORM_HARMONYOS=1",
                "__HARMONY__=1",
            ])
            files([
                "src/NKWindow/Platform/Noop/**.h",
            ])
            links(["log", "EGL", "GLESv3"])

        # â”€â”€ Xbox Series X/S et Xbox One (UWP / GameCore backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Le backend UWP fournit la fenÃªtre et les manettes via XInput/GameInput.
        # Le rendu pixel est gÃ©rÃ© par le software renderer (NkSoftwareRendererImpl).
        with filter("system:XboxSeries || system:XboxOne"):
            usetoolchain("xbox-clang")
            defines([
                "NKENTSEU_PLATFORM_UWP=1",
                "NKENTSEU_FAMILY_XBOX=1",
                "WINAPI_FAMILY=WINAPI_FAMILY_TV_APP",
                "_XBOX_ONE",
            ])
            files([
                "src/NKWindow/Platform/UWP/**.h",
            ])
            links(["d3d12", "dxgi", "dxguid", "xgameruntime"])

        # â”€â”€ Configurations Debug / Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("config:Debug"):
            defines(["_DEBUG", "DEBUG"])
            optimize("Off")
            symbols(True)
        with filter("config:Release"):
            defines(["NDEBUG", "RELEASE"])
            optimize("Speed")
            symbols(False)

        # Tests unitaires (desktop uniquement)
        with filter("system:Windows || system:Linux || system:macOS"):
            with test():
                testfiles(["tests/**.cpp"])

    # =========================================================================
    # Sandbox â€” Application de dÃ©monstration multi-plateformes
    # =========================================================================
    # La Sandbox illustre l'utilisation complÃ¨te du framework NKWindow :
    #   â€¢ CrÃ©ation de fenÃªtre et boucle principale cross-platform
    #   â€¢ Gestion des Ã©vÃ©nements : clavier, souris, touch, drag & drop
    #   â€¢ Rendu pixel software : pixels, lignes, cercles, rectangles, triangles
    #   â€¢ CamÃ©ra 2D : retirÃ©e du workflow par dÃ©faut
    #   â€¢ Gamepad : boutons, axes, rumble (XInput / Linux / HID)
    #   â€¢ Safe area : gestion des encoches et bords mobiles
    #   â€¢ Transforms 2D : retirÃ©s pour simplifier l'API de base
    #
    # Un seul fichier src/main.cpp compile pour TOUTES les plateformes.
    # Le point d'entrÃ©e natif (WinMain, main, android_main, etc.) est
    # abstrait par les macros NkEntry.h / NkMain.h de NKWindow.
    # =========================================================================

    startproject("Sandbox")

    with project("Sandbox"):
        windowedapp()
        language("C++")
        cppdialect("C++17")
        location("Sandbox")

        # Source unique multi-plateforme
        files(["src/main.cpp"])

        includedirs([
            "../NKWindow/src",     # API publique NKWindow (NkWindow.h, etc.)
            "../NKCore/src",       # Types fondamentaux (NkTypes, NkMacrosâ€¦)
            "../NKCore/pch",       # pch NKCore
            "../NKPlatform/src",   # DÃ©tection de plateforme
            "../NKPlatform/src/NKPlatform", # NkPlatformDetect.h (include public de NkWindow.h)
            "../NKLogger/src",     # Journalisation (Logger.h, Log.hâ€¦)
            "../Externals",        # stb et autres dÃ©pendances header-only
        ])

        # Lier toutes les bibliothÃ¨ques du framework
        links(["NKWindow", "NKLogger", "NKCore", "NKPlatform"])
        dependson(["NKWindow", "NKLogger", "NKCore", "NKPlatform"])

        objdir("%{wks.location}/Build/Obj/%{cfg.buildcfg}-%{cfg.system}/%{prj.name}")
        targetdir("%{wks.location}/Build/Bin/%{cfg.buildcfg}-%{cfg.system}/%{prj.name}")

        # â”€â”€ Windows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Windows"):
            windowedapp()
            usetoolchain(TC_WINDOWS)
            defines([
                "NKENTSEU_PLATFORM_WIN32=1",
                "NKENTSEU_FAMILY_WINDOWS=1",
                "WIN32_LEAN_AND_MEAN",
                "_UNICODE", "UNICODE",
            ])
            links([
                "user32", "gdi32", "opengl32", "dwmapi", "shell32",
                "xinput", "mf", "mfplat", "mfreadwrite", "mfuuid",
                "uuid", "ole32",
            ])

        # â”€â”€ Linux headless â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Linux && options:linux-backend=headless || system:Linux && options:headless"):
            windowedapp()
            usetoolchain("clang-native")
            defines(["NKENTSEU_PLATFORM_NOOP=1"])
            objdir("%{wks.location}/Build/Obj/%{cfg.buildcfg}-%{cfg.system}-headless/%{prj.name}")
            targetdir("%{wks.location}/Build/Bin/%{cfg.buildcfg}-%{cfg.system}-headless/%{prj.name}")
            links(["pthread"])

        # â”€â”€ Linux XLib â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Linux && options:linux-backend=xlib || system:Linux && !options:linux-backend && !options:headless"):
            windowedapp()
            usetoolchain("clang-native")
            defines(["NKENTSEU_PLATFORM_XLIB=1"])
            links(["pthread", "X11"])

        # â”€â”€ Linux XCB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Linux && options:linux-backend=xcb"):
            windowedapp()
            usetoolchain("clang-native")
            defines(["NKENTSEU_PLATFORM_XCB=1"])
            links(["pthread", "xcb", "xcb-icccm", "xcb-randr", "X11-xcb"])

        # â”€â”€ Linux Wayland â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Linux && options:linux-backend=wayland"):
            windowedapp()
            usetoolchain("clang-native")
            defines(["NKENTSEU_PLATFORM_WAYLAND=1"])
            links(["pthread", "wayland-client", "xkbcommon"])

        # â”€â”€ macOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:macOS"):
            windowedapp()
            usetoolchain("clang-native")
            defines(["NKENTSEU_PLATFORM_COCOA=1"])
            frameworks(["Cocoa", "QuartzCore", "OpenGL"])

        # â”€â”€ Android â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Android"):
            windowedapp()
            usetoolchain("android-ndk")
            defines(["NKENTSEU_PLATFORM_ANDROID=1"])
            links(["android", "log", "EGL", "GLESv3"])
            androidapplicationid("com.nkentseu.sandbox")
            androidminsdk(24)
            androidtargetsdk(34)
            androidcompilesdk(34)
            androidabis(["armeabi-v7a", "arm64-v8a", "x86", "x86_64"])
            androidnativeactivity(True)

        # â”€â”€ iOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:iOS"):
            windowedapp()
            defines(["NKENTSEU_PLATFORM_UIKIT=1"])
            frameworks(["UIKit", "QuartzCore", "OpenGLES"])
            iosbundleid("com.nkentseu.sandbox")
            iosversion("1.0")
            iosminsdk("14.0")
            iosbuildnumber(1)

        # â”€â”€ Web â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:Web"):
            consoleapp()
            usetoolchain("emscripten")
            defines(["NKENTSEU_PLATFORM_WASM=1"])
            emscriptencanvasid("canvas")
            emscripteninitialmemory(32)
            # Boucle principale synchrone (style SDL_Delay) sur le navigateur
            emscriptenextraflags(["-s", "ASYNCIFY"])

        # â”€â”€ HarmonyOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:HarmonyOS"):
            windowedapp()
            defines(["NKENTSEU_PLATFORM_HARMONYOS=1"])
            links(["log", "EGL", "GLESv3"])

        # â”€â”€ Xbox Series X/S et Xbox One â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("system:XboxSeries || system:XboxOne"):
            windowedapp()
            usetoolchain("xbox-clang")
            defines([
                "NKENTSEU_PLATFORM_UWP=1",
                "NKENTSEU_FAMILY_XBOX=1",
                "WINAPI_FAMILY=WINAPI_FAMILY_TV_APP",
            ])
            links(["d3d12", "dxgi", "dxguid", "xgameruntime"])

        # â”€â”€ Configurations Debug / Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        with filter("config:Debug"):
            defines(["_DEBUG"])
            optimize("Off")
            symbols(True)
        with filter("config:Release"):
            defines(["NDEBUG"])
            optimize("Speed")
            symbols(False)

